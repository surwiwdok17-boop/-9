{% extends "base.html" %}
{% block title %}API Demo{% endblock %}
{% block content %}
<h1 class="text-2xl font-bold text-center mb-6 text-emerald-700">–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—è API</h1>

<!-- –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è -->
<div id="message" class="hidden p-3 rounded mb-4"></div>

<!-- üîπ –ü—Ä–æ–¥—É–∫—Ç–∏ -->
<section class="mb-10">
  <h2 class="text-xl font-semibold mb-3">–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä—ñ–≤</h2>
  <button onclick="loadProducts()" class="bg-blue-500 text-white px-4 py-2 rounded">–û—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç–∏</button>
  <div id="products" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mt-4"></div>
</section>

<!-- üîπ –í—ñ–¥–≥—É–∫–∏ -->
<section>
  <h2 class="text-xl font-semibold mb-3">–ó–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫</h2>
  <form id="feedbackForm" class="space-y-3 mb-4 bg-gray-100 p-4 rounded shadow-sm">
    <input type="text" id="name" placeholder="–í–∞—à–µ —ñ–º‚Äô—è" required class="border px-3 py-2 w-full">
    <input type="email" id="email" placeholder="Email" required class="border px-3 py-2 w-full">
    <textarea id="messageField" placeholder="–í–∞—à –≤—ñ–¥–≥—É–∫" rows="3" required class="border px-3 py-2 w-full"></textarea>
    <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
  </form>

  <h2 class="text-xl font-semibold mb-3">–í—Å—ñ –≤—ñ–¥–≥—É–∫–∏</h2>
  <div id="feedback" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
</section>

<script>
const API_BASE = "/api";

// üîπ –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó
function showMessage(text, type="info") {
  const box = document.getElementById("message");
  box.textContent = text;
  box.className = `p-3 rounded mb-4 ${type === "success" ? "bg-green-200 text-green-800" : "bg-red-200 text-red-800"}`;
  box.classList.remove("hidden");
  setTimeout(() => box.classList.add("hidden"), 4000);
}

// üîπ –ü—Ä–æ–¥—É–∫—Ç–∏
async function loadProducts() {
  try {
    const res = await fetch(`${API_BASE}/products`);
    if (!res.ok) throw new Error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ–¥—É–∫—Ç—ñ–≤");
    const data = await res.json();

    const products = Array.isArray(data) ? data : data.products || [];

    document.getElementById("products").innerHTML =
      products.length === 0 ? "<p class='text-gray-500'>–ù–µ–º–∞—î –ø—Ä–æ–¥—É–∫—Ç—ñ–≤.</p>" :
      products.map(p => {
        // –∑–∞–ø–∞—Å–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç: —è–∫—â–æ image_url –≤—ñ–¥ API –Ω–µ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑ http –∞–±–æ '/', –¥–æ–¥–∞—î–º–æ /static/
        let img = p.image_url;
        if (img && !img.startsWith("http") && !img.startsWith("/")) {
          img = "/static/" + img.replace(/^\/+/, "");
        }
        return `<div class="bg-gray-50 border p-3 rounded shadow-sm text-center">
          <p class="font-bold text-lg mb-2">${p.name}</p>
          <p class="text-gray-700 mb-2">${p.price} –≥—Ä–Ω</p>
          ${img ? `<img src="${img}" alt="${p.name}" class="mx-auto w-32 h-32 object-contain">` : ""}
        </div>`;
      }).join("");
  } catch (err) {
    showMessage(err.message, "error");
  }
}

// üîπ –í—ñ–¥–≥—É–∫–∏
async function loadFeedback() {
  try {
    const res = await fetch(`${API_BASE}/feedback`);
    if (!res.ok) throw new Error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—ñ–¥–≥—É–∫—ñ–≤");
    const data = await res.json();

    const feedbackList = Array.isArray(data) ? data : data.feedback || [];

    document.getElementById("feedback").innerHTML =
      feedbackList.length === 0 ? "<p class='text-gray-500'>–í—ñ–¥–≥—É–∫—ñ–≤ —â–µ –Ω–µ–º–∞—î.</p>" :
      feedbackList.map(fb => `<div class="bg-gray-50 border p-3 rounded shadow-sm">
        <p class="font-bold text-emerald-700">${fb.name} <span class="text-sm text-gray-500">(${fb.email})</span></p>
        <p>${fb.message}</p>
        <button onclick="deleteFeedback(${fb.id})" class="text-red-600 text-sm mt-2">–í–∏–¥–∞–ª–∏—Ç–∏</button>
      </div>`).join("");
  } catch (err) {
    showMessage(err.message, "error");
  }
}

async function deleteFeedback(id) {
  try {
    const res = await fetch(`${API_BASE}/feedback/${id}`, { method: "DELETE" });
    if (!res.ok) throw new Error("–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ –≤—ñ–¥–≥—É–∫");
    showMessage("–í—ñ–¥–≥—É–∫ –≤–∏–¥–∞–ª–µ–Ω–æ", "success");
    loadFeedback();
  } catch (err) {
    showMessage(err.message, "error");
  }
}

// üîπ –î–æ–¥–∞–≤–∞–Ω–Ω—è –≤—ñ–¥–≥—É–∫—É
document.getElementById("feedbackForm").addEventListener("submit", async e => {
  e.preventDefault();
  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim();
  const message = document.getElementById("messageField").value.trim();

  if (name.length < 2) return showMessage("–Ü–º‚Äô—è –º–∞—î –º—ñ—Å—Ç–∏—Ç–∏ –º—ñ–Ω—ñ–º—É–º 2 —Å–∏–º–≤–æ–ª–∏", "error");
  if (!email.includes("@")) return showMessage("–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π email", "error");
  if (message.length < 3) return showMessage("–í—ñ–¥–≥—É–∫ –∑–∞–Ω–∞–¥—Ç–æ –∫–æ—Ä–æ—Ç–∫–∏–π", "error");

  try {
    const res = await fetch(`${API_BASE}/feedback`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, email, message })
    });
    if (!res.ok) throw new Error("–ù–µ –≤–¥–∞–ª–æ—Å—è –¥–æ–¥–∞—Ç–∏ –≤—ñ–¥–≥—É–∫");
    showMessage("–í—ñ–¥–≥—É–∫ —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ!", "success");
    e.target.reset();
    loadFeedback();
  } catch (err) {
    showMessage(err.message, "error");
  }
});

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
loadProducts();
loadFeedback();
</script>
{% endblock %}
